<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="/bower_components/polymer/lib/utils/debounce.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="bubble-game-node">
  <template>
    <style>
      :host {
        display: block;
        padding: 10px;
      }
    </style>

    <template is="dom-if" if="[[gameKey]]">
      <firebase-document
          path="gameModel/game/[[gameKey]]"
          data="{{game}}">
      </firebase-query>

      <iron-ajax
          id="newgame"
          url="https://us-central1-gdgphbubbles.cloudfunctions.net/auth/newplayer"
          method="POST"
          content-type="application/json"
          handle-as="json"
          on-response="handleBubbles">
      </iron-ajax>

      <iron-ajax
          id="bubbles"
          url="https://us-central1-gdgphbubbles.cloudfunctions.net/auth/getbubbles"
          method="POST"
          content-type="application/json"
          handle-as="json"
          on-response="handleBubbles">
      </iron-ajax>

      <template is="dom-if" if="[[checkStatusActive(game.status)]]">
        [[game.status]]
        [[team]]
        <br/>
        <template is="dom-repeat" items="[[questions]]">
          [[item.question]]<br/>
        </template>
      </template>
    </template>

  </template>

  <script>
    (() => {
      class BubbleGameNode extends Polymer.Element {
        static get is() { return 'bubble-game-node'; }
        static get properties() {
          return {
            gameKey: {
              type: String
            },
            game: {
              type: Object,
              value: null
            },
            user: {
              type: Object,
              value: null
            },
            team: {
              type: String,
              value: null
            }
          }
        }
        static get observers() {
          return [
            'checkTeam(game.status, gameKey)'
          ]
        }

        disconnectedCallback() {
          super.disconnectedCallback()
          if (this.teamRef) {
            this.teamRef.off()
          }
        }

        checkStatusActive(status) {
          return status === 'active'
        }

        checkTeam(status, key) {
          if (key && status && status === 'active') {
            this.teamRef = firebase.database().ref(`gameModel/gamePlayers/${key}/players/${this.user.uid}/team`).on('value', this.setTeam.bind(this))
          }
        }

        setTeam(data) {
          if (data.exists()) {
            this.team = data.val()
            var ajax = this.shadowRoot.querySelector('#bubbles');
            this.user.getIdToken().then((token) => {
              ajax.headers = {
                Authorization: 'Bearer ' + token
              };
              ajax.body = JSON.stringify({
                gameId: this.gameKey
              })
              this._debouncerBubbles = Polymer.Debouncer.debounce(this._debouncerBubbles, Polymer.Async.timeOut.after(250), () => { this.generateBubbles() });
            })
          } else {
            console.log('no team')
            var ajax = this.shadowRoot.querySelector('#newgame');
            this.user.getIdToken().then((token) => {
              ajax.headers = {
                Authorization: 'Bearer ' + token
              };
              ajax.body = JSON.stringify({
                gameId: this.gameKey
              })
              this._debouncerNewGame = Polymer.Debouncer.debounce(this._debouncerNewGame, Polymer.Async.timeOut.after(250), () => { this.generateNewGame() });
            })
          }
        }

        generateBubbles() {
          this.shadowRoot.querySelector('#bubbles').generateRequest()
        }

        generateNewGame() {
          this.shadowRoot.querySelector('#newgame').generateRequest()
        }

        handleNewPlayer(e) {
          var response = e.detail.response
          console.log(response)
        }

        handleBubbles(e) {
          var response = e.detail.response
          this.questions = response.questions;
        }
      }

      window.customElements.define(BubbleGameNode.is, BubbleGameNode);
    })()
  </script>
</dom-module>
